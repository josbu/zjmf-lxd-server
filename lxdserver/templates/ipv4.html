<style>
/* 简洁专业设计风格 */
.ipv4-card {
    border: 1px solid #e1e5e9;
    border-radius: 8px;
    background: #ffffff;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.ipv4-card-header {
    background: #4a5568;
    border-radius: 8px 8px 0 0;
    color: white;
    border: none;
}

.modern-table {
    border: 1px solid #e1e5e9;
    border-radius: 6px;
    overflow: hidden;
    background: #fff;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.modern-table thead {
    background: #f8f9fa;
    color: #495057;
}

.modern-table thead th {
    border: none;
    padding: 10px 12px;
    font-weight: 600;
    font-size: 0.8rem;
    border-bottom: 2px solid #e9ecef;
}

.modern-table thead th i {
    margin-right: 6px;
    color: #6c757d;
}

.modern-table tbody tr {
    border: none;
    transition: background-color 0.2s ease;
    border-bottom: 1px solid #e9ecef;
}

.modern-table tbody tr:hover {
    background-color: #f8f9fa;
}

.modern-table tbody tr:last-child {
    border-bottom: none;
}

.modern-table tbody td {
    border: none;
    padding: 10px 12px;
    vertical-align: middle;
    font-size: 0.85rem;
}

.ipv4-address {
    background: #e3f2fd;
    color: #1976d2;
    border: 1px solid #bbdefb;
    padding: 5px 10px;
    border-radius: 4px;
    font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
    font-weight: 600;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.2s ease;
    display: inline-block;
    min-width: 140px;
    text-align: center;
}

.ipv4-address:hover {
    background: #bbdefb;
    color: #0d47a1;
}

.status-badge {
    padding: 4px 12px;
    border-radius: 4px;
    font-weight: 500;
    font-size: 0.8rem;
    display: inline-block;
    min-width: 60px;
    text-align: center;
}

.status-active {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.status-inactive {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.action-btn {
    background: #ffffff;
    color: #dc3545;
    border: 1px solid #dc3545;
    padding: 5px 10px;
    border-radius: 4px;
    font-weight: 500;
    font-size: 0.75rem;
    transition: all 0.2s ease;
}

.action-btn:hover {
    background: #dc3545;
    color: #ffffff;
}

.btn-create {
    background: #007bff;
    border: 1px solid #007bff;
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    font-weight: 500;
    font-size: 0.75rem;
    transition: all 0.2s ease;
}

.btn-create:hover {
    background: #0056b3;
    border-color: #0056b3;
    color: white;
}

.description-text {
    background: #f8f9fa;
    color: #6c757d;
    padding: 6px 10px;
    border-radius: 4px;
    font-style: italic;
    font-size: 0.85rem;
    border-left: 3px solid #007bff;
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.badge-modern {
    background: #6c757d;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: 500;
    font-size: 0.8rem;
}

.badge-success-modern {
    background: #007bff;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: 500;
    font-size: 0.8rem;
}

@media (max-width: 768px) {
    .modern-table thead th,
    .modern-table tbody td {
        padding: 8px 6px;
        font-size: 0.75rem;
    }
    
    .ipv4-address {
        font-size: 0.7rem;
        padding: 4px 8px;
        min-width: 120px;
    }
    
    .action-btn {
        font-size: 0.7rem;
        padding: 4px 6px;
    }
    
    .status-badge {
        font-size: 0.65rem;
        padding: 2px 6px;
    }
}
</style>

<div class="container-fluid" id="ipv4Manager">
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-network-wired mr-2"></i>IPv4独立绑定管理
                    </h6>
                    <small class="text-muted">管理容器的独立公网IPv4地址</small>
                    <div class="mt-2">
                        <span class="badge badge-secondary ml-2">
                            已绑定: <span id="current-ipv4-count">0</span>/{$ipv4_limit} 个
                        </span>
                        <span class="badge badge-success ml-1">
                            剩余: <span id="remaining-ipv4-count">0</span> 个
                        </span>
                    </div>
                </div>
                <div class="d-flex">
                    <button class="btn btn-create btn-sm mr-2" data-toggle="modal" data-target="#addIPv4Modal" id="add-ipv4-btn">
                        <i class="fas fa-plus mr-1"></i>绑定IPv4
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="refreshIPv4List()">
                        <i class="fas fa-sync-alt mr-1"></i>刷新
                    </button>
                </div>
            </div>
        </div>

        <div class="card-body">
            <div id="ipv4-empty-state" class="text-center py-5" style="display:none">
                <div class="empty-state-content">
                    <i class="fas fa-network-wired fa-4x text-muted mb-4" style="opacity:0.3"></i>
                    <h4 class="text-muted mb-3">暂无IPv4绑定</h4>
                    <p class="text-muted mb-4">您还没有创建任何IPv4独立地址绑定</p>
                    <button class="btn btn-create btn-lg" data-toggle="modal" data-target="#addIPv4Modal" style="border-radius: 17px; padding: 6px 20px;">
                        <i class="fas fa-plus mr-2"></i>创建第一个IPv4绑定
                    </button>
                </div>
            </div>

            <div id="ipv4-list-container" style="display:block">
                <div class="table-responsive">
                    <table class="table modern-table mb-0">
                        <thead>
                            <tr>
                                <th style="width:50%">
                                    <i class="fas fa-network-wired"></i>公网IPv4地址
                                </th>
                                <th style="width:25%">
                                    <i class="fas fa-comment-alt"></i>描述信息
                                </th>
                                <th style="width:15%">
                                    <i class="fas fa-chart-line"></i>状态
                                </th>
                                <th style="width:10%">
                                    <i class="fas fa-cogs"></i>操作
                                </th>
                            </tr>
                        </thead>
                        <tbody id="ipv4-tbody">
                            <tr class="loading-row">
                                <td colspan="4" class="text-center py-4">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>加载中...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addIPv4Modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus-circle text-primary mr-2"></i>绑定独立IPv4地址
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" onclick="closeAddModal()">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-primary mb-3">
                        <i class="fas fa-info-circle mr-1"></i><strong>功能说明:</strong> 系统将分配一个独立的公网IPv4地址
                    </div>
                    <form id="addIPv4Form">
                        <div class="form-group">
                            <label>
                                <i class="fas fa-server mr-1"></i>容器名称
                            </label>
                            <input type="text" class="form-control" value="{$container_name}" disabled>
                        </div>
                        <div class="form-group">
                            <label for="ipv4Description">
                                <i class="fas fa-comment mr-1"></i>描述信息 (可选)
                            </label>
                            <input name="description" type="text" class="form-control" id="ipv4Description" 
                                   placeholder="请输入绑定描述">
                            <small class="form-text text-muted">为该IPv4绑定添加描述信息，方便管理</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm mr-2" data-dismiss="modal" onclick="closeAddModal()">
                        <i class="fas fa-times mr-1"></i>取消
                    </button>
                    <button type="button" class="btn btn-primary btn-sm confirm-btn-ipv4">
                        <i class="fas fa-check mr-1"></i>确认绑定
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow mt-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-question-circle mr-2"></i>使用说明
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <ul class="list-unstyled">
                        <li class="mb-2"><i class="fas fa-network-wired text-primary mr-2"></i><strong>公网IPv4:</strong> 系统分配的独立公网地址</li>
                        <li class="mb-2"><i class="fas fa-server text-primary mr-2"></i><strong>容器IPv4:</strong> 容器内部的IPv4地址</li>
                        <li class="mb-2"><i class="fas fa-link text-info mr-2"></i><strong>自动路由:</strong> 所有流量自动路由到容器</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <ul class="list-unstyled">
                        <li class="mb-2"><i class="fas fa-copy text-warning mr-2"></i>点击IPv4地址可复制到剪贴板</li>
                        <li class="mb-2"><i class="fas fa-trash text-danger mr-2"></i>删除绑定将立即停止路由</li>
                        <li class="mb-2"><i class="fas fa-shield-alt text-secondary mr-2"></i>容器IPv4地址绑定有数量限制</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
var currentContainerId = '';
var MODULE_API_URL = "{$MODULE_CUSTOM_API}";
var currentContainerName = '{$container_name}';
var ipv4Limit = {$ipv4_limit};
var currentIPv4Count = 0;
var ipv4AllowDelete = {if condition="$ipv4_allow_delete"}true{else/}false{/if};

$(document).ready(function() {
    const urlParams = new URLSearchParams(window.location.search);
    const containerId = urlParams.get('id');
    if (containerId) {
        currentContainerId = containerId;
        fetchIPv4List();
        setInterval(fetchIPv4List, 30000);
    }
});

function fetchIPv4List() {
    if (!currentContainerId) return;
    
    const timestamp = new Date().getTime();
    const ipv4ListUrl = `/provision/custom/content?id=${currentContainerId}&key=ipv4_acl&action=ipv4list&_t=${timestamp}`;

    $.ajax({
        url: ipv4ListUrl,
        method: 'GET',
        dataType: 'json',
        timeout: 10000,
        cache: false,
        success: function(resp) {
            if (resp && resp.data && resp.data.list && Array.isArray(resp.data.list)) {
                const list = resp.data.list;
                const $empty = $('#ipv4-empty-state');
                const $listContainer = $('#ipv4-list-container');
                const $tbody = $('#ipv4-tbody');
                
                if (list.length === 0) {
                    $empty.show();
                    $listContainer.hide();
                    updateIPv4Counters(0);
                } else {
                    $empty.hide();
                    $listContainer.show();
                    
                    $tbody.html('<tr class="loading-row"><td colspan="4" class="text-center py-4"><i class="fas fa-spinner fa-spin mr-2"></i>更新中...</td></tr>');
                    
                    setTimeout(function() {
                        let html = '';
                        list.forEach(function(item) {
                            const publicIPv4 = item.public_ipv4 || '';
                            const status = item.status || 'active';
                            const description = item.description || '';
                            
                            let statusBadge;
                            if (status === 'active') {
                                statusBadge = '<span class="status-badge status-active"><i class="fas fa-check-circle mr-1"></i>正常</span>';
                            } else {
                                statusBadge = '<span class="status-badge status-inactive"><i class="fas fa-exclamation-triangle mr-1"></i>异常</span>';
                            }
                            
                            let descriptionDisplay = '';
                            if (description && description.trim() !== '') {
                                descriptionDisplay = '<div class="description-text" title="' + description + '">' + description + '</div>';
                            } else {
                                const autoDescription = `独立IPv4地址 (${publicIPv4})`;
                                descriptionDisplay = '<div class="description-text text-muted" title="' + autoDescription + '" style="font-style: italic;">' + autoDescription + '</div>';
                            }
                            
                            let actionButton = '';
                            if (ipv4AllowDelete) {
                                actionButton = '<button class="btn action-btn delete-ipv4-btn" data-ipv4="' + publicIPv4 + '" title="删除此IPv4绑定"><i class="fas fa-trash-alt"></i></button>';
                            } else {
                                actionButton = '<button class="btn btn-secondary btn-sm" disabled title="管理员已禁止删除IP"><i class="fas fa-lock"></i></button>';
                            }
                            
                            html += '<tr>' +
                                    '<td><div class="ipv4-address" onclick="copyToClipboard(\'' + publicIPv4 + '\')" title="点击复制IPv4地址">' + publicIPv4 + '</div></td>' +
                                    '<td>' + descriptionDisplay + '</td>' +
                                    '<td>' + statusBadge + '</td>' +
                                    '<td>' + actionButton + '</td>' +
                                    '</tr>';
                        });
                        $tbody.html(html);
                        updateIPv4Counters(list.length);
                    }, 300);
                }
            }
        },
        error: function(xhr, status, error) {
            console.error('IPv4列表获取失败:', error);
        }
    });
}

function updateIPv4Counters(count) {
    currentIPv4Count = count;
    const remainingCount = Math.max(0, ipv4Limit - count);
    
    $('#current-ipv4-count').text(count);
    $('#remaining-ipv4-count').text(remainingCount);
    
    const $addBtn = $('#add-ipv4-btn');
    if (count >= ipv4Limit) {
        $addBtn.prop('disabled', true);
        $addBtn.html('<i class="fas fa-ban mr-1"></i>已达限制');
        $addBtn.removeClass('btn-create').addClass('btn-secondary btn-sm');
        $addBtn.attr('title', `IPv4绑定数量已达到限制（${ipv4Limit}个）`);
    } else {
        $addBtn.prop('disabled', false);
        $addBtn.html('<i class="fas fa-plus mr-1"></i>绑定IPv4');
        $addBtn.removeClass('btn-secondary').addClass('btn-create btn-sm');
        $addBtn.attr('title', '');
    }
}

function copyToClipboard(text) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(function() {
            Swal.fire({
                type: 'success',
                title: '复制成功',
                text: 'IPv4地址已复制到剪贴板: ' + text,
                timer: 2000,
                showConfirmButton: false
            });
        }).catch(function() {
            fallbackCopyTextToClipboard(text);
        });
    } else {
        fallbackCopyTextToClipboard(text);
    }
}

function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    try {
        document.execCommand('copy');
        Swal.fire({
            type: 'success',
            title: '复制成功',
            text: 'IPv4地址已复制到剪贴板: ' + text,
            timer: 2000,
            showConfirmButton: false
        });
    } catch (err) {
        Swal.fire({
            type: 'error',
            title: '复制失败',
            text: '请手动复制地址: ' + text
        });
    }
    document.body.removeChild(textArea);
}

function refreshIPv4List() {
    fetchIPv4List();
}

function closeAddModal() {
    setTimeout(function() {
        const formEl = document.getElementById('addIPv4Form');
        if (formEl) formEl.reset();
    }, 150);
}

// 删除IPv4绑定
$(document).on('click', '.delete-ipv4-btn', function (e) {
    e.preventDefault();
    if ($(this).data('disabled') == 'true') return;

    const delete_ipv4_btn = $(this);
    const publicIPv4 = delete_ipv4_btn.data('ipv4');

    Swal.fire({
        type: 'warning',
        title: '删除IPv4绑定',
        html: `<div class="text-muted">公网IPv4地址: <span class="badge badge-primary">${publicIPv4}</span></div>`,
        showCancelButton: true,
        reverseButtons: true,
        buttonsStyling: false,
        customClass: {
            popup: 'swal2-bootstrap-card',
            confirmButton: 'btn btn-danger',
            cancelButton: 'btn btn-secondary mr-3'
        },
        confirmButtonText: '确认删除',
        cancelButtonText: '取消'
    }).then((result) => {
        if (result.value) {
            delete_ipv4_btn.data('orig-html', delete_ipv4_btn.html());
            delete_ipv4_btn.html('<i class="fas fa-circle-notch fa-spin"></i>');
            delete_ipv4_btn.data('disabled', 'true');

            ajax({
                type: 'post',
                url: MODULE_API_URL,
                data: { func: 'ipv4del', public_ipv4: publicIPv4 },
                success: function (data) {
                    delete_ipv4_btn.html(delete_ipv4_btn.data('orig-html') || '删除');
                    delete_ipv4_btn.data('disabled', 'false');
                    
                    const isSuccess = data.status === 200 || data.status === '200' ||
                                    data.code === 200 || data.code === '200' ||
                                    data.status === 'success';

                    if (isSuccess) {
                        Swal.fire({
                            type: 'success',
                            title: '删除成功',
                            text: data.msg || data.message || 'IPv4绑定删除成功',
                            timer: 2000,
                            showConfirmButton: false
                        });
                        fetchIPv4List();
                    } else {
                        Swal.fire({
                            type: 'error',
                            title: '删除失败',
                            text: data.msg || data.message || '操作失败'
                        });
                    }
                },
                error: function (xhrStatus, errorData) {
                    delete_ipv4_btn.html(delete_ipv4_btn.data('orig-html') || '删除');
                    delete_ipv4_btn.data('disabled', 'false');
                    
                    Swal.fire({
                        type: 'error',
                        title: '删除失败',
                        text: '网络或服务器错误'
                    });
                }
            });
        }
    });
});

// 添加IPv4绑定
$('.confirm-btn-ipv4').on('click', function () {
    if (!currentContainerName) {
        Swal.fire({
            type: 'error',
            title: '容器信息未加载',
            text: '请稍后再试'
        });
        return;
    }

    if (currentIPv4Count >= ipv4Limit) {
        Swal.fire({
            type: 'warning',
            title: 'IPv4绑定数量已达限制',
            text: `您的容器最多只能创建 ${ipv4Limit} 个IPv4绑定`,
            confirmButtonText: '我知道了'
        });
        return;
    }

    if (!$(this).data('submit')) {
        var current_button = $(this);
        current_button.data('orig-html', current_button.html());
        current_button.html('<i class="fas fa-circle-notch fa-spin"></i>');
        current_button.data('submit', 'submit');

        ajax({
            type: 'post',
            url: MODULE_API_URL,
            data: $('#addIPv4Form').serialize() + '&func=ipv4add',
            success: function (data) {
                current_button.html(current_button.data('orig-html') || '确认绑定');
                current_button.data('submit', '');

                if (!data || typeof data !== 'object') {
                    Swal.fire({
                        type: 'error',
                        title: '绑定失败',
                        text: '服务器响应格式异常'
                    });
                    return;
                }

                const isSuccess = data.status === 200 || data.status === '200' ||
                                data.code === 200 || data.code === '200' ||
                                data.status === 'success';

                if (isSuccess) {
                    Swal.fire({
                        type: 'success',
                        title: '绑定成功',
                        text: data.msg || data.message || 'IPv4绑定添加成功',
                        timer: 2000,
                        showConfirmButton: false
                    });

                    $('#addIPv4Modal').modal('hide');
                    closeAddModal();
                    setTimeout(function() {
                        fetchIPv4List();
                    }, 100);
                } else {
                    Swal.fire({
                        type: 'error',
                        title: '绑定失败',
                        text: data.msg || data.message || '操作失败'
                    });
                }
            },
            error: function (xhrStatus, errorData) {
                current_button.html(current_button.data('orig-html') || '确认绑定');
                current_button.data('submit', '');

                Swal.fire({
                    type: 'error',
                    title: '绑定失败',
                    text: '网络或服务器错误'
                });
            }
        });
    }
});

function ajax(options) {
    var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft,XMLHTTP");
    var str = "";

    if (typeof options.data != 'string') {
        for (var key in options.data) {
            str += "&" + key + "=" + options.data[key];
        }
        str = str.slice(1);
    } else {
        str = options.data;
    }

    if (options.type == "get") {
        xhr.open("get", options.url + "?" + str);
        xhr.setRequestHeader("Authorization", "JWT {$Think.get.jwt}");
        xhr.send();
    } else if (options.type == "post") {
        xhr.open("post", options.url);
        xhr.setRequestHeader("content-type", "application/x-www-form-urlencoded");
        xhr.setRequestHeader("Authorization", "JWT {$Think.get.jwt}");
        xhr.send(str);
    }

    xhr.onreadystatechange = function () {
        if (xhr.readyState == 4 && xhr.status == 200) {
            try {
                var d = JSON.parse(xhr.responseText);
                options.success && options.success(d, xhr.responseXML);
            } catch (e) {
                options.error && options.error(xhr.status, 'JSON解析错误');
            }
        } else if (xhr.readyState == 4 && xhr.status != 200) {
            try {
                var parsedErrorData = JSON.parse(xhr.responseText);
                options.error && options.error(xhr.status, parsedErrorErrorData);
            } catch (e) {
                options.error && options.error(xhr.status, xhr.responseText);
            }
        }
    };
}
</script>

