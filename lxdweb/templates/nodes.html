<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body class="bg-gray-50">
    {{template "header.html" .}}
    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">èŠ‚ç‚¹ç®¡ç†</h1>
                <p class="text-gray-600 mt-1">ç®¡ç†å’Œç›‘æ§æ‰€æœ‰ LXD èŠ‚ç‚¹</p>
            </div>
            <button onclick="showAddModal()" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200 shadow-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                æ·»åŠ èŠ‚ç‚¹
            </button>
        </div>
        <div id="nodesGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
            <div class="col-span-full text-center py-12">
                <span class="loading loading-spinner loading-lg"></span>
                <p class="text-gray-500 mt-4">åŠ è½½èŠ‚ç‚¹æ•°æ®...</p>
            </div>
        </div>
    </div>
    <dialog id="nodeModal" class="modal">
        <div class="modal-box">
            <h3 id="modalTitle" class="font-bold text-lg mb-4">æ·»åŠ èŠ‚ç‚¹</h3>
            <form id="nodeForm" class="space-y-4">
                <input type="hidden" id="nodeId">
                <div class="form-control">
                    <label class="label"><span class="label-text">èŠ‚ç‚¹åç§° *</span></label>
                    <input type="text" id="nodeName" required class="input input-bordered">
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text">APIåœ°å€ *</span></label>
                    <input type="text" id="nodeAddress" required placeholder="" class="input input-bordered">
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text">APIå¯†é’¥</span></label>
                    <input type="password" id="nodeApiKey" class="input input-bordered">
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text">æè¿°</span></label>
                    <textarea id="nodeDescription" rows="3" class="textarea textarea-bordered"></textarea>
                </div>
                <div class="modal-action">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg transition">å–æ¶ˆ</button>
                    <button type="submit" class="px-4 py-2 text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition">ä¿å­˜</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop"><button onclick="closeModal()">close</button></form>
    </dialog>
    <script>
        $(document).ready(function() {
            loadNodes();
        });
        function loadNodes() {
            $.get('/api/nodes', function(result) {
                if (result.code === 200) {
                    renderNodes(result.data);
                } else {
                    $('#nodesGrid').html('<div class="col-span-full text-center py-12 text-red-600">åŠ è½½å¤±è´¥: ' + result.msg + '</div>');
                }
            }).fail(function() {
                $('#nodesGrid').html('<div class="col-span-full text-center py-12 text-red-600">åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</div>');
            });
        }
        function renderNodes(nodes) {
            if (!nodes || nodes.length === 0) {
                $('#nodesGrid').html(`
                    <div class="col-span-full text-center py-12">
                        <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path>
                        </svg>
                        <p class="text-gray-500">æš‚æ— èŠ‚ç‚¹ï¼Œç‚¹å‡»"æ·»åŠ èŠ‚ç‚¹"å¼€å§‹</p>
                    </div>
                `);
                return;
            }
            const cards = nodes.map(node => createNodeCard(node)).join('');
            $('#nodesGrid').html(cards);
        }
        function createNodeCard(node) {
            const statusBadge = getStatusBadge(node.status);
            const sysInfo = node.system_info || {};
            const system = sysInfo.system || {};
            return `
                <div class="bg-white rounded-lg border border-gray-200 hover:border-blue-300 hover:shadow-md transition-all duration-200">
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1 min-w-0">
                                <h3 class="font-semibold text-gray-800 text-base truncate">${node.name}</h3>
                                <p class="text-xs text-gray-500 mt-0.5 truncate">${node.description || 'æš‚æ— æè¿°'}</p>
                            </div>
                            ${statusBadge}
                        </div>
                        ${sysInfo.version ? `
                            <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-md p-3 mb-3 space-y-1.5 text-xs">
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-600">ç‰ˆæœ¬</span>
                                    <span class="font-medium text-gray-800">${sysInfo.version}</span>
                                </div>
                                ${system.arch ? `
                                    <div class="flex items-center justify-between">
                                        <span class="text-gray-600">æ¶æ„</span>
                                        <span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded font-medium">${system.arch}</span>
                                    </div>
                                ` : ''}
                                ${sysInfo.lxd_version ? `
                                    <div class="flex items-center justify-between">
                                        <span class="text-gray-600">LXD</span>
                                        <span class="font-medium text-gray-800">${sysInfo.lxd_version}</span>
                                    </div>
                                ` : ''}
                                ${system.distribution ? `
                                    <div class="pt-1 border-t border-gray-200">
                                        <span class="text-gray-600">ç³»ç»Ÿ</span>
                                        <div class="text-gray-700 font-medium mt-0.5 leading-tight">${system.distribution.split(' (')[0]}</div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : `
                            <div class="bg-amber-50 border border-amber-200 rounded-md p-2.5 mb-3 text-xs text-amber-700 flex items-center gap-1.5">
                                <svg class="w-3.5 h-3.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                <span>æ— æ³•è·å–ç³»ç»Ÿä¿¡æ¯</span>
                            </div>
                        `}
                        <div class="flex items-center gap-1.5 text-xs text-gray-500 mb-3 bg-gray-50 rounded px-2 py-1.5">
                            <svg class="w-3.5 h-3.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                            </svg>
                            <span class="truncate font-mono">${node.address.replace(/^https?:\/\//, '')}</span>
                        </div>
                        <div class="flex gap-1.5">
                            <button onclick="testNode(${node.id})" class="flex-1 px-2 py-1.5 text-xs font-medium text-green-700 bg-green-50 hover:bg-green-100 border border-green-200 rounded transition" title="æµ‹è¯•è¿æ¥">
                                âš¡ æµ‹è¯•
                            </button>
                            <button onclick="editNode(${node.id})" class="flex-1 px-2 py-1.5 text-xs font-medium text-blue-700 bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded transition">
                                âœï¸ ç¼–è¾‘
                            </button>
                            <button onclick="deleteNode(${node.id})" class="flex-1 px-2 py-1.5 text-xs font-medium text-red-700 bg-red-50 hover:bg-red-100 border border-red-200 rounded transition">
                                ğŸ—‘ åˆ é™¤
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        function getStatusBadge(status) {
            const badges = {
                'active': '<span class="px-2 py-0.5 text-xs font-medium text-green-700 bg-green-100 rounded-full flex items-center gap-1"><span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>åœ¨çº¿</span>',
                'inactive': '<span class="px-2 py-0.5 text-xs font-medium text-gray-600 bg-gray-100 rounded-full">ç¦»çº¿</span>',
                'error': '<span class="px-2 py-0.5 text-xs font-medium text-red-700 bg-red-100 rounded-full">é”™è¯¯</span>'
            };
            return badges[status] || badges.inactive;
        }
        function showAddModal() {
            $('#modalTitle').text('æ·»åŠ èŠ‚ç‚¹');
            $('#nodeForm')[0].reset();
            $('#nodeId').val('');
            document.getElementById('nodeModal').showModal();
        }
        function editNode(id) {
            $.get(`/api/nodes/${id}`, function(result) {
                if (result.code === 200) {
                    const node = result.data;
                    $('#modalTitle').text('ç¼–è¾‘èŠ‚ç‚¹');
                    $('#nodeId').val(node.id);
                    $('#nodeName').val(node.name);
                    $('#nodeAddress').val(node.address);
                    $('#nodeApiKey').val(node.api_key);
                    $('#nodeDescription').val(node.description);
                    document.getElementById('nodeModal').showModal();
                } else {
                    alert('è·å–èŠ‚ç‚¹ä¿¡æ¯å¤±è´¥');
                }
            });
        }
        function closeModal() {
            document.getElementById('nodeModal').close();
        }
        $('#nodeForm').on('submit', function(e) {
            e.preventDefault();
            const id = $('#nodeId').val();
            const data = {
                name: $('#nodeName').val(),
                address: $('#nodeAddress').val(),
                api_key: $('#nodeApiKey').val(),
                description: $('#nodeDescription').val()
            };
            const url = id ? `/api/nodes/${id}` : '/api/nodes';
            const method = id ? 'PUT' : 'POST';
            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(result) {
                    if (result.code === 200) {
                        closeModal();
                        loadNodes();
                        alert(id ? 'èŠ‚ç‚¹æ›´æ–°æˆåŠŸ' : 'èŠ‚ç‚¹åˆ›å»ºæˆåŠŸ');
                    } else {
                        alert(result.msg);
                    }
                },
                error: function() {
                    alert('æ“ä½œå¤±è´¥');
                }
            });
        });
        function testNode(id) {
            const $btn = $(`button[onclick="testNode(${id})"]`);
            const originalHtml = $btn.html();
            $btn.html('<span class="loading loading-spinner loading-xs"></span>').prop('disabled', true);
            $.post(`/api/nodes/${id}/test`, function(result) {
                $btn.html(originalHtml).prop('disabled', false);
                alert(result.msg);
                loadNodes();
            }).fail(function() {
                $btn.html(originalHtml).prop('disabled', false);
                alert('æµ‹è¯•å¤±è´¥');
            });
        }
        function deleteNode(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤èŠ‚ç‚¹å—ï¼Ÿ')) return;
            $.ajax({
                url: `/api/nodes/${id}`,
                method: 'DELETE',
                success: function(result) {
                    if (result.code === 200) {
                        loadNodes();
                        alert('èŠ‚ç‚¹åˆ é™¤æˆåŠŸ');
                    } else {
                        alert(result.msg);
                    }
                },
                error: function() {
                    alert('åˆ é™¤å¤±è´¥');
                }
            });
        }
    </script>
</body>
</html>
