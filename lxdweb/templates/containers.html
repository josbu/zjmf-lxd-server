<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body class="bg-gray-50">
    {{template "header.html" .}}
    
    <!-- å®¹å™¨è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="containerDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50" onclick="if(event.target === this) closeContainerDetail()">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gradient-to-r from-indigo-600 to-indigo-700">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    ğŸ“Š å®¹å™¨è¯¦æƒ… - <span id="detailHostname"></span>
                </h2>
                <div class="flex items-center gap-2">
                    <button onclick="manualRefreshDetail()" class="px-3 py-1 text-sm bg-white bg-opacity-20 hover:bg-opacity-30 text-white rounded transition" title="æ‰‹åŠ¨åˆ·æ–°">
                        ğŸ”„ åˆ·æ–°
                    </button>
                    <button onclick="closeContainerDetail()" class="text-white hover:text-gray-200 text-2xl leading-none">&times;</button>
                </div>
            </div>
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-80px)]">
                <div id="detailContent" class="text-center py-8">
                    <span class="loading loading-spinner loading-lg text-indigo-600"></span>
                    <p class="text-gray-600 mt-2">åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">å®¹å™¨ç®¡ç†</h1>
                <div class="flex items-center gap-3 mt-1">
                    <p class="text-gray-600">ç›‘æ§å’Œç®¡ç†æ‰€æœ‰LXDå®¹å™¨</p>
                    <div id="syncStatusIndicator" class="hidden">
                        <span class="flex items-center gap-2 text-sm text-blue-600">
                            <span class="loading loading-spinner loading-xs"></span>
                            <span id="syncStatusText">æ­£åœ¨åŒæ­¥ä¸­...</span>
                        </span>
                    </div>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="loadContainers()" class="btn-action bg-gray-500 hover:bg-gray-600">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span>åˆ·æ–°é¡µé¢</span>
                </button>
                <button onclick="syncAllNodes()" id="syncAllBtn" class="btn-action bg-green-500 hover:bg-green-600">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                    <span>åŒæ­¥æ‰€æœ‰èŠ‚ç‚¹</span>
                </button>
                <button onclick="showSyncHistory()" class="btn-action bg-blue-500 hover:bg-blue-600">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>åŒæ­¥å†å²</span>
            </button>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <div class="flex flex-wrap gap-4 items-center">
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700">èŠ‚ç‚¹ç­›é€‰:</label>
                    <select id="nodeFilter" onchange="filterContainers()" class="px-3 py-1 border border-gray-300 rounded-lg text-sm">
                        <option value="">å…¨éƒ¨èŠ‚ç‚¹</option>
                    </select>
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700">çŠ¶æ€ç­›é€‰:</label>
                    <select id="statusFilter" onchange="filterContainers()" class="px-3 py-1 border border-gray-300 rounded-lg text-sm">
                        <option value="">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="Running">è¿è¡Œä¸­</option>
                        <option value="Stopped">å·²åœæ­¢</option>
                        <option value="Frozen">å·²å†»ç»“</option>
                    </select>
                </div>
                <div class="flex items-center gap-2 flex-1">
                    <label class="text-sm font-medium text-gray-700">æœç´¢:</label>
                    <input type="text" id="searchInput" oninput="filterContainers()" placeholder="å®¹å™¨åç§°æˆ–IP" class="px-3 py-1 border border-gray-300 rounded-lg text-sm flex-1 max-w-xs">
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700">æ¯é¡µ:</label>
                    <select id="pageSize" onchange="changePageSize()" class="px-3 py-1 border border-gray-300 rounded-lg text-sm">
                        <option value="25">25æ¡</option>
                        <option value="50" selected>50æ¡</option>
                        <option value="100">100æ¡</option>
                        <option value="300">300æ¡</option>
                    </select>
                </div>
                <div class="flex gap-6 ml-auto">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-gray-800" id="totalCount">0</div>
                        <div class="text-xs text-gray-500">æ€»å®¹å™¨</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600" id="runningCount">0</div>
                        <div class="text-xs text-gray-500">è¿è¡Œä¸­</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-gray-600" id="stoppedCount">0</div>
                        <div class="text-xs text-gray-500">å·²åœæ­¢</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow">
            <div class="p-6">
                <div class="overflow-x-auto">
                    <table class="table table-zebra table-sm">
                        <thead>
                            <tr>
                                <th onclick="sortBy('hostname')" class="cursor-pointer hover:bg-gray-100">
                                    å®¹å™¨åç§° <span class="sort-icon">â‡…</span>
                                </th>
                                <th>èŠ‚ç‚¹</th>
                                <th onclick="sortBy('status')" class="cursor-pointer hover:bg-gray-100">
                                    çŠ¶æ€ <span class="sort-icon">â‡…</span>
                                </th>
                                <th>IPåœ°å€</th>
                                <th onclick="sortBy('cpu_usage')" class="cursor-pointer hover:bg-gray-100">
                                    CPU <span class="sort-icon">â‡…</span>
                                </th>
                                <th onclick="sortBy('memory_usage')" class="cursor-pointer hover:bg-gray-100">
                                    å†…å­˜ <span class="sort-icon">â‡…</span>
                                </th>
                                <th onclick="sortBy('disk_usage')" class="cursor-pointer hover:bg-gray-100">
                                    ç¡¬ç›˜ <span class="sort-icon">â‡…</span>
                                </th>
                                <th onclick="sortBy('traffic_total')" class="cursor-pointer hover:bg-gray-100">
                                    æµé‡ <span class="sort-icon">â‡…</span>
                                </th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="containerTableBody">
                            <tr>
                                <td colspan="9" class="text-center">åŠ è½½ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- åˆ†é¡µæ§ä»¶ -->
            <div class="border-t px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="text-sm text-gray-600">
                        æ˜¾ç¤ºç¬¬ <span id="pageStartNum">0</span> - <span id="pageEndNum">0</span> æ¡ï¼Œå…± <span id="filteredCount">0</span> æ¡
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="goToPage(1)" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed" id="firstPageBtn">
                            é¦–é¡µ
                        </button>
                        <button onclick="goToPage(currentPage - 1)" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed" id="prevPageBtn">
                            ä¸Šä¸€é¡µ
                        </button>
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-600">ç¬¬</span>
                            <input type="number" id="pageInput" min="1" value="1" class="w-16 px-2 py-1 text-sm text-center border border-gray-300 rounded" onkeypress="handlePageInputEnter(event)">
                            <span class="text-sm text-gray-600">/ <span id="totalPages">1</span> é¡µ</span>
                            <button onclick="goToInputPage()" class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">
                                è·³è½¬
                            </button>
                        </div>
                        <button onclick="goToPage(currentPage + 1)" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed" id="nextPageBtn">
                            ä¸‹ä¸€é¡µ
                        </button>
                        <button onclick="goToPage(totalPagesCount)" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed" id="lastPageBtn">
                            æœ«é¡µ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <style>
        /* ç»Ÿä¸€æŒ‰é’®æ ·å¼ */
        .btn-action {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: white;
            border-radius: 0.5rem;
            transition: all 0.2s;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            border: none;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .btn-action:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-action svg {
            flex-shrink: 0;
        }
        
        .sort-icon {
            font-size: 0.75rem;
            color: #9ca3af;
        }
        
        .progress-bar {
            height: 6px;
            border-radius: 3px;
            background: #e5e7eb;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            transition: width 0.3s;
        }
        
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }
    </style>
    <script>
        let nodes = [];
        let allContainers = [];
        let filteredContainers = [];
        let currentSort = {field: 'hostname', asc: true};
        let currentPage = 1;
        let pageSize = 50;
        let totalPagesCount = 1;
        
        $(document).ready(function() {
            loadNodes();
            loadContainers();
        });
        function formatBytes(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        function getProgressColor(percent) {
            if (percent >= 90) return '#ef4444';
            if (percent >= 75) return '#f59e0b';
            if (percent >= 50) return '#3b82f6';
            return '#10b981';
        }
        function renderProgress(value, total) {
            if (!value || !total) return '<span class="text-gray-400 text-xs">-</span>';
            const percent = (value / total * 100).toFixed(1);
            const color = getProgressColor(percent);
            return `
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${percent}%; background: ${color}"></div>
                </div>
            `;
        }
        function renderContainers(containers) {
            filteredContainers = containers;
            
            // è®¡ç®—æ€»é¡µæ•°
            totalPagesCount = Math.ceil(containers.length / pageSize);
            if (totalPagesCount === 0) totalPagesCount = 1;
            
            // ç¡®ä¿å½“å‰é¡µä¸è¶…è¿‡æ€»é¡µæ•°
            if (currentPage > totalPagesCount) {
                currentPage = totalPagesCount;
            }
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateStats(containers);
            
            // æ›´æ–°åˆ†é¡µä¿¡æ¯
            updatePaginationInfo(containers.length);
            
            // è®¡ç®—å½“å‰é¡µæ•°æ®
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, containers.length);
            const pageContainers = containers.slice(startIndex, endIndex);
            
            if (pageContainers.length === 0) {
                $('#containerTableBody').html('<tr><td colspan="9" class="text-center text-gray-500">æš‚æ— å®¹å™¨æ•°æ®</td></tr>');
                return;
            }
            
            const rows = pageContainers.map(c => {
                const badges = {
                    'Running': '<span class="badge badge-success badge-sm gap-1">è¿è¡Œä¸­</span>',
                    'Stopped': '<span class="badge badge-ghost badge-sm gap-1">å·²åœæ­¢</span>',
                    'Frozen': '<span class="badge badge-info badge-sm gap-1">å·²å†»ç»“</span>'
                };
                const badge = badges[c.status] || badges.Stopped;
                
                // CPU: æ˜¾ç¤ºæ ¸å¿ƒæ•°å’Œç™¾åˆ†æ¯”
                const cpuCores = c.cpus || 1;
                const cpuPercent = c.cpu_usage ? parseFloat(c.cpu_usage).toFixed(1) : 0;
                const cpuDisplay = `<div class="text-xs font-medium ${cpuPercent > 80 ? 'text-red-600' : 'text-gray-700'}">${cpuCores}æ ¸ (${cpuPercent}%)</div>`;
                
                // å†…å­˜: æ˜¾ç¤ºç™¾åˆ†æ¯” + ä½¿ç”¨é‡/æ€»é‡ + è¿›åº¦æ¡
                const memoryDisplay = (c.memory_usage && c.memory_total) 
                    ? (() => {
                        const percent = (c.memory_usage / c.memory_total * 100).toFixed(1);
                        return `<div class="text-xs text-gray-600 mb-1">${percent}% | ${formatBytes(c.memory_usage)} / ${formatBytes(c.memory_total)}</div>` + renderProgress(c.memory_usage, c.memory_total);
                    })()
                    : '<span class="text-gray-400 text-xs">-</span>';
                
                // ç£ç›˜: æ˜¾ç¤ºç™¾åˆ†æ¯” + ä½¿ç”¨é‡/æ€»é‡ + è¿›åº¦æ¡
                const diskDisplay = (c.disk_usage && c.disk_total)
                    ? (() => {
                        const percent = (c.disk_usage / c.disk_total * 100).toFixed(1);
                        return `<div class="text-xs text-gray-600 mb-1">${percent}% | ${formatBytes(c.disk_usage)} / ${formatBytes(c.disk_total)}</div>` + renderProgress(c.disk_usage, c.disk_total);
                    })()
                    : '<span class="text-gray-400 text-xs">-</span>';
                
                // æµé‡: æ˜¾ç¤ºç™¾åˆ†æ¯” + ä½¿ç”¨é‡/é™é¢ + è¿›åº¦æ¡
                const trafficDisplay = (c.traffic_total && c.traffic_limit) 
                    ? (() => {
                        const percent = (c.traffic_total / (c.traffic_limit * 1024 * 1024 * 1024) * 100).toFixed(1);
                        return `<div class="text-xs text-gray-600 mb-1">${percent}% | ${formatBytes(c.traffic_total)} / ${c.traffic_limit} GB</div>` + renderProgress(c.traffic_total, c.traffic_limit * 1024 * 1024 * 1024);
                    })()
                    : '<span class="text-gray-400 text-xs">-</span>';
                return `
                    <tr class="hover:bg-gray-50">
                        <td>
                            <div class="font-semibold text-gray-800 text-sm">${c.hostname}</div>
                            <div class="text-xs text-gray-500">
                                ${c.last_sync ? 'åŒæ­¥: ' + formatSyncTime(c.last_sync) : 'æœªåŒæ­¥'}
                            </div>
                        </td>
                        <td>
                            <span class="badge badge-outline badge-xs">${c.node_name}</span>
                        </td>
                        <td>${badge}</td>
                        <td class="text-xs">
                            ${c.ipv4 ? `<code class="bg-blue-50 px-1 py-0.5 rounded">${c.ipv4}</code>` : '<span class="text-gray-400">-</span>'}
                        </td>
                        <td>${cpuDisplay}</td>
                        <td style="min-width: 140px">${memoryDisplay}</td>
                        <td style="min-width: 140px">${diskDisplay}</td>
                        <td style="min-width: 140px">${trafficDisplay}</td>
                        <td>
                            <div class="flex gap-1 flex-wrap">
                                <button onclick="showContainerDetail('${c.hostname}', ${c.node_id})" class="px-2 py-1 text-xs text-white bg-indigo-600 hover:bg-indigo-700 rounded transition" title="è¯¦æƒ…">ğŸ“Š</button>
                                <button onclick="startContainer('${c.hostname}', ${c.node_id})" class="px-2 py-1 text-xs text-white bg-green-600 hover:bg-green-700 rounded transition" title="å¯åŠ¨">â–¶</button>
                                <button onclick="stopContainer('${c.hostname}', ${c.node_id})" class="px-2 py-1 text-xs text-white bg-orange-600 hover:bg-orange-700 rounded transition" title="åœæ­¢">â– </button>
                                <button onclick="restartContainer('${c.hostname}', ${c.node_id})" class="px-2 py-1 text-xs text-white bg-blue-600 hover:bg-blue-700 rounded transition" title="é‡å¯">âŸ³</button>
                                <button onclick="openConsole('${c.hostname}', ${c.node_id})" class="px-2 py-1 text-xs text-white bg-purple-600 hover:bg-purple-700 rounded transition" title="æ§åˆ¶å°" ${c.status !== 'Running' ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}>ğŸ–¥</button>
                                <button onclick="deleteContainer('${c.hostname}', ${c.node_id})" class="px-2 py-1 text-xs text-white bg-red-600 hover:bg-red-700 rounded transition" title="åˆ é™¤">ğŸ—‘</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            $('#containerTableBody').html(rows);
        }
        
        function updatePaginationInfo(totalCount) {
            const startNum = totalCount === 0 ? 0 : (currentPage - 1) * pageSize + 1;
            const endNum = Math.min(currentPage * pageSize, totalCount);
            
            $('#pageStartNum').text(startNum);
            $('#pageEndNum').text(endNum);
            $('#filteredCount').text(totalCount);
            $('#totalPages').text(totalPagesCount);
            $('#pageInput').val(currentPage);
            $('#pageInput').attr('max', totalPagesCount);
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            $('#firstPageBtn, #prevPageBtn').prop('disabled', currentPage === 1);
            $('#nextPageBtn, #lastPageBtn').prop('disabled', currentPage === totalPagesCount);
        }
        
        function changePageSize() {
            pageSize = parseInt($('#pageSize').val());
            currentPage = 1;
            renderContainers(filteredContainers);
        }
        
        function goToPage(page) {
            if (page < 1 || page > totalPagesCount) return;
            currentPage = page;
            renderContainers(filteredContainers);
            // å¹³æ»‘æ»šåŠ¨åˆ°è¡¨æ ¼é¡¶éƒ¨
            $('html, body').animate({
                scrollTop: $('.bg-white.rounded-lg.shadow').offset().top - 100
            }, 300);
        }
        
        function goToInputPage() {
            const page = parseInt($('#pageInput').val());
            if (!isNaN(page)) {
                goToPage(page);
            }
        }
        
        function handlePageInputEnter(event) {
            if (event.keyCode === 13) {
                goToInputPage();
            }
        }
        function sortBy(field) {
            if (currentSort.field === field) {
                currentSort.asc = !currentSort.asc;
            } else {
                currentSort.field = field;
                currentSort.asc = true;
            }
            allContainers.sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = (bVal || '').toLowerCase();
                } else if (typeof aVal === 'undefined') {
                    aVal = 0;
                    bVal = bVal || 0;
                }
                if (currentSort.asc) {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            currentPage = 1;
            filterContainers();
        }
        function updateStats(containers) {
            const total = containers.length;
            const running = containers.filter(c => c.status === 'Running').length;
            const stopped = containers.filter(c => c.status === 'Stopped').length;
            $('#totalCount').text(total);
            $('#runningCount').text(running);
            $('#stoppedCount').text(stopped);
        }
        function filterContainers() {
            const nodeFilter = $('#nodeFilter').val();
            const statusFilter = $('#statusFilter').val();
            const searchText = $('#searchInput').val().toLowerCase();
            let filtered = allContainers;
            if (nodeFilter) {
                filtered = filtered.filter(c => c.node_id == nodeFilter);
            }
            if (statusFilter) {
                filtered = filtered.filter(c => c.status === statusFilter);
            }
            if (searchText) {
                filtered = filtered.filter(c => 
                    c.hostname.toLowerCase().includes(searchText) ||
                    (c.ipv4 && c.ipv4.includes(searchText)) ||
                    (c.ipv6 && c.ipv6.includes(searchText))
                );
            }
            currentPage = 1; // ç­›é€‰åé‡ç½®åˆ°ç¬¬ä¸€é¡µ
            renderContainers(filtered);
        }
        function loadNodes() {
            $.get('/api/nodes', function(result) {
                if (result.code === 200) {
                    nodes = result.data;
                    const activeNodes = nodes.filter(n => n.status === 'active');
                    const createOptions = '<option value="">è¯·é€‰æ‹©èŠ‚ç‚¹</option>' + 
                        activeNodes.map(n => `<option value="${n.id}">${n.name}</option>`).join('');
                    $('#createNodeId').html(createOptions);
                    const filterOptions = '<option value="">å…¨éƒ¨èŠ‚ç‚¹</option>' + 
                        nodes.map(n => `<option value="${n.id}">${n.name} ${n.status === 'active' ? '' : '(ç¦»çº¿)'}</option>`).join('');
                    $('#nodeFilter').html(filterOptions);
                }
            });
        }
        function loadContainers() {
            $('#containerTableBody').html('<tr><td colspan="9" class="text-center"><span class="loading loading-spinner loading-md"></span> ä»ç¼“å­˜åŠ è½½ä¸­...</td></tr>');
            $.get('/api/containers', function(result) {
                if (result.code === 200) {
                    allContainers = result.data || [];
                    console.log('åŠ è½½åˆ°çš„å®¹å™¨æ•°æ®:', allContainers);
                    filterContainers();
                } else {
                    $('#containerTableBody').html(`<tr><td colspan="9" class="text-center text-error">åŠ è½½å¤±è´¥: ${result.msg || 'æœªçŸ¥é”™è¯¯'}</td></tr>`);
                }
            }).fail(function(xhr) {
                console.error('åŠ è½½å®¹å™¨å¤±è´¥:', xhr);
                $('#containerTableBody').html('<tr><td colspan="9" class="text-center text-error">åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡è¿æ¥</td></tr>');
            });
        }
        
        function formatSyncTime(timeStr) {
            if (!timeStr) return 'æœªçŸ¥';
            const time = new Date(timeStr);
            const now = new Date();
            const diff = Math.floor((now - time) / 1000);
            
            if (diff < 60) return 'åˆšåˆš';
            if (diff < 3600) return Math.floor(diff / 60) + 'åˆ†é’Ÿå‰';
            if (diff < 86400) return Math.floor(diff / 3600) + 'å°æ—¶å‰';
            return time.toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        }
        
        function syncAllNodes() {
            if (!confirm('ç¡®å®šè¦åŒæ­¥æ‰€æœ‰èŠ‚ç‚¹çš„å®¹å™¨ä¿¡æ¯å—ï¼Ÿ\n\næ­¤æ“ä½œå°†å¹¶å‘è·å–æ‰€æœ‰å®¹å™¨çš„æœ€æ–°çŠ¶æ€ï¼Œå¯èƒ½éœ€è¦å‡ ç§’é’Ÿæ—¶é—´ã€‚')) {
                return;
            }
            
            const $btn = $('#syncAllBtn');
            const originalHtml = $btn.html();
            $btn.html('<span class="loading loading-spinner loading-xs"></span> åŒæ­¥ä¸­...').prop('disabled', true);
            
            $.ajax({
                url: '/api/sync/all',
                type: 'POST',
                contentType: 'application/json',
                success: function(result) {
                    if (result.code === 200) {
                        showToast('success', result.msg || 'åŒæ­¥ä»»åŠ¡å·²å¯åŠ¨');
                        // 3ç§’åå¼€å§‹è½®è¯¢çŠ¶æ€
                        setTimeout(() => {
                            startSyncStatusPolling();
                        }, 3000);
                    } else {
                        showToast('error', result.msg || 'åŒæ­¥å¯åŠ¨å¤±è´¥');
                        $btn.html(originalHtml).prop('disabled', false);
                    }
                },
                error: function(xhr) {
                    showToast('error', 'åŒæ­¥å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    $btn.html(originalHtml).prop('disabled', false);
                }
            });
        }
        
        let syncStatusInterval = null;
        
        function startSyncStatusPolling() {
            $('#syncStatusIndicator').removeClass('hidden');
            
            if (syncStatusInterval) {
                clearInterval(syncStatusInterval);
            }
            
            syncStatusInterval = setInterval(() => {
                $.get('/api/sync/status', function(result) {
                    if (result.code === 200) {
                        const statuses = result.data || [];
                        const syncing = statuses.some(s => s.syncing);
                        
                        if (syncing) {
                            const syncingNodes = statuses.filter(s => s.syncing).map(s => s.node_name).join(', ');
                            $('#syncStatusText').text(`æ­£åœ¨åŒæ­¥: ${syncingNodes}`);
                        } else {
                            // åŒæ­¥å®Œæˆ
                            clearInterval(syncStatusInterval);
                            syncStatusInterval = null;
                            $('#syncStatusIndicator').addClass('hidden');
                            $('#syncAllBtn').html(`
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                <span>åŒæ­¥æ‰€æœ‰èŠ‚ç‚¹</span>
                            `).prop('disabled', false);
                            
                            showToast('success', 'åŒæ­¥å®Œæˆï¼æ­£åœ¨åˆ·æ–°æ•°æ®...');
                            loadContainers();
                        }
                    }
                });
            }, 2000);
        }
        
        function showSyncHistory() {
            $.get('/api/sync/tasks', function(result) {
                if (result.code === 200) {
                    const tasks = result.data || [];
                    
                    let html = `
                        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeModal(event)">
                            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] overflow-auto m-4" onclick="event.stopPropagation()">
                                <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                                    <h2 class="text-2xl font-bold text-gray-800">åŒæ­¥å†å²è®°å½•</h2>
                                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                                </div>
                                <div class="p-6">
                    `;
                    
                    if (tasks.length === 0) {
                        html += '<p class="text-center text-gray-500 py-8">æš‚æ— åŒæ­¥è®°å½•</p>';
                    } else {
                        html += '<div class="space-y-4">';
                        tasks.forEach(task => {
                            const statusBadge = {
                                'completed': '<span class="badge badge-success badge-sm">æˆåŠŸ</span>',
                                'failed': '<span class="badge badge-error badge-sm">å¤±è´¥</span>',
                                'running': '<span class="badge badge-info badge-sm">è¿è¡Œä¸­</span>',
                                'pending': '<span class="badge badge-ghost badge-sm">ç­‰å¾…ä¸­</span>'
                            };
                            
                            const startTime = task.start_time ? new Date(task.start_time).toLocaleString('zh-CN') : '-';
                            const endTime = task.end_time ? new Date(task.end_time).toLocaleString('zh-CN') : '-';
                            const duration = (task.start_time && task.end_time) 
                                ? `${Math.round((new Date(task.end_time) - new Date(task.start_time)) / 1000)}ç§’`
                                : '-';
                            
                            html += `
                                <div class="border rounded-lg p-4 hover:bg-gray-50">
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <span class="font-semibold text-gray-800">${task.node_name}</span>
                                            ${statusBadge[task.status] || statusBadge.pending}
                                        </div>
                                        <span class="text-xs text-gray-500">${startTime}</span>
                                    </div>
                                    <div class="grid grid-cols-4 gap-4 text-sm mt-3">
                                        <div>
                                            <div class="text-gray-500 text-xs">æ€»æ•°</div>
                                            <div class="font-semibold">${task.total_count}</div>
                                        </div>
                                        <div>
                                            <div class="text-gray-500 text-xs">æˆåŠŸ</div>
                                            <div class="font-semibold text-green-600">${task.success_count}</div>
                                        </div>
                                        <div>
                                            <div class="text-gray-500 text-xs">å¤±è´¥</div>
                                            <div class="font-semibold text-red-600">${task.failed_count}</div>
                                        </div>
                                        <div>
                                            <div class="text-gray-500 text-xs">è€—æ—¶</div>
                                            <div class="font-semibold">${duration}</div>
                                        </div>
                                    </div>
                                    ${task.error_message ? `<div class="mt-2 text-xs text-red-600 bg-red-50 p-2 rounded">${task.error_message}</div>` : ''}
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                    
                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                    
                    $('body').append(html);
                } else {
                    showToast('error', 'è·å–åŒæ­¥å†å²å¤±è´¥');
                }
            });
        }
        
        function closeModal(event) {
            if (event) event.stopPropagation();
            $('.fixed.inset-0').remove();
        }
        
        function showToast(type, message) {
            const colors = {
                'success': 'bg-green-600',
                'error': 'bg-red-600',
                'info': 'bg-blue-600'
            };
            
            const toast = $(`
                <div class="fixed top-4 right-4 ${colors[type] || colors.info} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in">
                    ${message}
                </div>
            `);
            
            $('body').append(toast);
            
            setTimeout(() => {
                toast.fadeOut(300, function() { $(this).remove(); });
            }, 3000);
        }
        function startContainer(name, nodeId) {
            containerAction(name, nodeId, 'start', 'å¯åŠ¨');
        }
        function stopContainer(name, nodeId) {
            containerAction(name, nodeId, 'stop', 'åœæ­¢');
        }
        function restartContainer(name, nodeId) {
            containerAction(name, nodeId, 'restart', 'é‡å¯');
        }
        function deleteContainer(name, nodeId) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å®¹å™¨ ${name} å—ï¼Ÿ`)) return;
            containerAction(name, nodeId, 'delete', 'åˆ é™¤');
        }
        function openConsole(hostname, nodeId) {
            const $btn = $(`button[onclick="openConsole('${hostname}', ${nodeId})"]`);
            const originalHtml = $btn.html();
            $btn.html('â³').prop('disabled', true);
            $.ajax({
                url: '/api/console/token',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    hostname: hostname,
                    node_id: nodeId
                }),
                success: function(result) {
                    $btn.html(originalHtml).prop('disabled', false);
                    if (result.code === 200) {
                        const consoleUrl = result.data.console_url;
                        const consoleWindow = window.open(consoleUrl, '_blank', 'width=1200,height=800,menubar=no,toolbar=no,location=no,status=no');
                        if (!consoleWindow) {
                            alert('æ— æ³•æ‰“å¼€æ§åˆ¶å°çª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å¼¹çª—æ‹¦æˆªè®¾ç½®');
                        }
                    } else {
                        alert('è·å–æ§åˆ¶å°å¤±è´¥: ' + result.msg);
                    }
                },
                error: function(xhr) {
                    $btn.html(originalHtml).prop('disabled', false);
                    alert('è·å–æ§åˆ¶å°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                }
            });
        }
        function containerAction(name, nodeId, action, actionName) {
            $.post(`/api/containers/${name}/${action}?node_id=${nodeId}`, function(result) {
                alert(result.msg || `${actionName}ä»»åŠ¡å·²æäº¤`);
                setTimeout(loadContainers, 2000);
            }).fail(function() {
                alert(`${actionName}å¤±è´¥`);
            });
        }
        
        // å®¹å™¨è¯¦æƒ…ç›¸å…³
        let detailRefreshInterval = null;
        let currentDetailHostname = null;
        let currentDetailNodeId = null;
        
        function showContainerDetail(hostname, nodeId) {
            currentDetailHostname = hostname;
            currentDetailNodeId = nodeId;
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('containerDetailModal').classList.remove('hidden');
            document.getElementById('detailHostname').textContent = hostname;
            
            // åŠ è½½è¯¦æƒ…
            loadContainerDetail(hostname, nodeId);
            
            // å¼€å§‹å®šæ—¶åˆ·æ–°ï¼ˆæ¯5ç§’ï¼‰
            if (detailRefreshInterval) {
                clearInterval(detailRefreshInterval);
            }
            detailRefreshInterval = setInterval(() => {
                loadContainerDetail(hostname, nodeId);
            }, 10000);
        }
        
        function closeContainerDetail() {
            document.getElementById('containerDetailModal').classList.add('hidden');
            currentDetailHostname = null;
            currentDetailNodeId = null;
            if (detailRefreshInterval) {
                clearInterval(detailRefreshInterval);
                detailRefreshInterval = null;
            }
        }
        
        function manualRefreshDetail() {
            if (currentDetailHostname && currentDetailNodeId) {
                loadContainerDetail(currentDetailHostname, currentDetailNodeId);
            }
        }
        
        function loadContainerDetail(hostname, nodeId) {
            const $content = $('#detailContent');
            
            $.get(`/api/containers/${hostname}?node_id=${nodeId}`, function(result) {
                if (result.code === 200) {
                    const data = result.data;
                    const cpuColor = data.cpu_percent > 80 ? 'text-red-600' : data.cpu_percent > 50 ? 'text-orange-600' : 'text-green-600';
                    const memoryPercent = data.memory_percent || 0;
                    const diskPercent = data.disk_percent || 0;
                    
                    $content.html(`
                        <div class="space-y-4">
                            <!-- åŸºæœ¬ä¿¡æ¯ -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h3 class="text-sm font-semibold text-gray-700 mb-3">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h3>
                                <div class="grid grid-cols-2 gap-3 text-sm">
                                    <div><span class="text-gray-600">å®¹å™¨åç§°:</span> <span class="font-medium">${data.hostname}</span></div>
                                    <div><span class="text-gray-600">çŠ¶æ€:</span> <span class="badge ${data.status === 'Running' ? 'badge-success' : 'badge-ghost'} badge-sm">${data.status}</span></div>
                                    <div><span class="text-gray-600">IPv4:</span> <code class="text-xs bg-blue-50 px-2 py-1 rounded">${data.ipv4 || '-'}</code></div>
                                    <div><span class="text-gray-600">IPv6:</span> <code class="text-xs bg-blue-50 px-2 py-1 rounded">${data.ipv6 || '-'}</code></div>
                                    <div><span class="text-gray-600">é•œåƒ:</span> <span class="text-xs">${data.image || '-'}</span></div>
                                    <div><span class="text-gray-600">åˆ›å»ºæ—¶é—´:</span> <span class="text-xs">${data.created_at ? new Date(data.created_at).toLocaleString('zh-CN') : '-'}</span></div>
                                </div>
                            </div>
                            
                            <!-- èµ„æºé…ç½® -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h3 class="text-sm font-semibold text-gray-700 mb-3">âš™ï¸ èµ„æºé…ç½®</h3>
                                <div class="grid grid-cols-2 gap-3 text-sm">
                                    <div><span class="text-gray-600">CPUæ ¸å¿ƒ:</span> <span class="font-medium">${data.cpus || data.config?.cpus || '-'} æ ¸</span></div>
                                    <div><span class="text-gray-600">å†…å­˜:</span> <span class="font-medium">${data.config?.memory || data.memory + 'MB' || '-'}</span></div>
                                    <div><span class="text-gray-600">ç£ç›˜:</span> <span class="font-medium">${data.config?.disk || data.disk + 'MB' || '-'}</span></div>
                                    <div><span class="text-gray-600">æµé‡é™åˆ¶:</span> <span class="font-medium">${data.config?.traffic_limit ? data.config.traffic_limit + ' GB' : 'æ— é™åˆ¶'}</span></div>
                                </div>
                            </div>
                            
                            <!-- å®æ—¶ä½¿ç”¨æƒ…å†µ -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h3 class="text-sm font-semibold text-gray-700 mb-3">ğŸ“Š å®æ—¶ä½¿ç”¨æƒ…å†µ</h3>
                                <div class="space-y-3">
                                    <!-- CPU -->
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="text-gray-600">CPUä½¿ç”¨ç‡</span>
                                            <span class="font-semibold ${cpuColor}">${data.cpus || data.config?.cpus || 1}æ ¸ (${(data.cpu_percent || data.cpu_usage || 0).toFixed(1)}%)</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="h-2 rounded-full transition-all" style="width: ${Math.min(data.cpu_percent || data.cpu_usage || 0, 100)}%; background: ${data.cpu_percent > 80 ? '#ef4444' : data.cpu_percent > 50 ? '#f59e0b' : '#10b981'}"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- å†…å­˜ -->
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="text-gray-600">å†…å­˜ä½¿ç”¨</span>
                                            <span class="font-medium">${data.memory_usage || '-'} / ${data.config?.memory || '-'} (${memoryPercent.toFixed(1)}%)</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="h-2 rounded-full transition-all" style="width: ${Math.min(memoryPercent, 100)}%; background: ${memoryPercent > 80 ? '#ef4444' : memoryPercent > 50 ? '#f59e0b' : '#10b981'}"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- ç£ç›˜ -->
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="text-gray-600">ç£ç›˜ä½¿ç”¨</span>
                                            <span class="font-medium">${data.disk_usage || '-'} / ${data.config?.disk || '-'} (${diskPercent.toFixed(1)}%)</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="h-2 rounded-full transition-all" style="width: ${Math.min(diskPercent, 100)}%; background: ${diskPercent > 80 ? '#ef4444' : diskPercent > 50 ? '#f59e0b' : '#10b981'}"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- æµé‡ -->
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="text-gray-600">æµé‡ä½¿ç”¨</span>
                                            <span class="font-medium">${data.traffic_usage || '0 B'}${data.config?.traffic_limit ? (() => {
                                                const trafficBytes = data.traffic_usage_raw || 0;
                                                const limitBytes = data.config.traffic_limit * 1024 * 1024 * 1024;
                                                const trafficPercent = (trafficBytes / limitBytes * 100).toFixed(1);
                                                return ' / ' + data.config.traffic_limit + ' GB (' + trafficPercent + '%)';
                                            })() : ''}</span>
                                        </div>
                                        ${data.config?.traffic_limit ? (() => {
                                            const trafficBytes = data.traffic_usage_raw || 0;
                                            const limitBytes = data.config.traffic_limit * 1024 * 1024 * 1024;
                                            const trafficPercent = (trafficBytes / limitBytes * 100).toFixed(1);
                                            return `
                                                <div class="w-full bg-gray-200 rounded-full h-2">
                                                    <div class="h-2 rounded-full transition-all" style="width: ${Math.min(trafficPercent, 100)}%; background: ${trafficPercent > 80 ? '#ef4444' : trafficPercent > 50 ? '#f59e0b' : '#10b981'}"></div>
                                                </div>
                                            `;
                                        })() : '<div class="text-xs text-gray-400">-</div>'}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- æœ€åæ›´æ–°æ—¶é—´ -->
                            <div class="text-xs text-gray-500 text-center">
                                <span>æœ€åæ›´æ–°: ${data.last_update || new Date().toLocaleTimeString('zh-CN')}</span>
                                <span class="ml-2">â±ï¸ æ¯5ç§’è‡ªåŠ¨åˆ·æ–°</span>
                            </div>
                        </div>
                    `);
                } else {
                    $content.html(`<div class="text-center text-red-600 py-8">åŠ è½½å¤±è´¥: ${result.msg}</div>`);
                }
            }).fail(function() {
                $content.html(`<div class="text-center text-red-600 py-8">ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥</div>`);
            });
        }
    </script>
</body>
</html>
